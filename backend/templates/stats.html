{% extends "base.html" %}
{% block content %}
<h2 class="page-title">ğŸ“Š çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>

<!-- ===============================
     ã‚°ãƒ©ãƒ•ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚«ãƒ¼ãƒ‰UIï¼‰
=============================== -->
<div class="stats-grid">

  <div class="stats-card">
    <h3>MBTI</h3>
    <canvas id="mbtiChart"></canvas>
  </div>

  <div class="stats-card">
    <h3>ãƒ©ãƒ–ã‚¿ã‚¤ãƒ—</h3>
    <canvas id="loveChart"></canvas>
  </div>

  <div class="stats-card">
    <h3>è¡€æ¶²å‹</h3>
    <canvas id="bloodChart"></canvas>
  </div>

  <div class="stats-card">
    <h3>ã‚°ãƒ«ãƒ¼ãƒ—ã‚¿ã‚°</h3>
    <canvas id="tagChart"></canvas>
  </div>

</div>


<!-- ========== ãƒ¡ãƒ³ãƒãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
<div id="memberModal" class="modal-overlay">
  <div class="modal-box" style="width:400px; max-height:70%; overflow-y:auto; position:relative;">
    <button onclick="closeModal()" class="close-x">âœ–</button>
    <h3 id="modalTitle" style="margin-top:0;">ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</h3>
    <ul id="memberList" style="list-style:none; padding-left:0;"></ul>
  </div>
</div>


<!-- ===== Chart.js ===== -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<script id="chart-data" type="application/json">
{
  "mbti": {{ mbti_counts | tojson | safe }},
  "love": {{ love_counts | tojson | safe }},
  "blood": {{ blood_counts | tojson | safe }},
  "tags": {{ tag_counts | tojson | safe }}
}
</script>

<script>
const chartData = JSON.parse(document.getElementById("chart-data").textContent);
const MBTI_LABELS_MAP = {{ MBTI_LABELS | tojson | safe }};
const LOVE_LABELS_MAP = {{ LOVE_LABELS | tojson | safe }};


// ===== MBTI ã‚«ãƒ©ãƒ¼è¨­å®š =====
const MBTI_GROUPS = {
  purple: ["INTJ","INTP","ENTJ","ENTP"],
  green:  ["INFJ","INFP","ENFJ","ENFP"],
  blue:   ["ISTJ","ISFJ","ESTJ","ESFJ"],
  yellow: ["ISTP","ISFP","ESTP","ESFP"]
};
const MBTI_GROUP_COLORS = {
  purple: ["#D1C4E9","#B39DDB","#9575CD","#7E57C2"],
  green:  ["#C8E6C9","#A5D6A7","#81C784","#66BB6A"],
  blue:   ["#BBDEFB","#90CAF9","#64B5F6","#42A5F5"],
  yellow: ["#FFF9C4","#FFF59D","#FFF176","#FFEE58"]
};
const MBTI_COLOR_MAP = {};
Object.entries(MBTI_GROUPS).forEach(([group, types]) => {
  types.forEach((t, i) => MBTI_COLOR_MAP[t] = MBTI_GROUP_COLORS[group][i]);
});

const MBTI_ORDER = [
  "INTJ","INTP","ENTJ","ENTP",
  "INFJ","INFP","ENFJ","ENFP",
  "ISTJ","ISFJ","ESTJ","ESFJ",
  "ISTP","ISFP","ESTP","ESFP"
];


// ===== è‰²å®šç¾© =====
const COLORS = {
  love: ["#F8BBD0","#F48FB1","#F06292","#EC407A","#FFE0B2","#FFCC80","#FFB74D","#FFA726",
         "#B3E5FC","#81D4FA","#4FC3F7","#29B6F6","#E1BEE7","#CE93D8","#BA68C8","#AB47BC"],
  blood: ["#FFCDD2","#F8BBD0","#BBDEFB","#C8E6C9"],
  tags: ["#81D4FA","#AED581","#FFB74D","#BA68C8","#E57373","#4DB6AC","#FFD54F","#7986CB","#F06292","#A1887F"]
};


// ===== ã‚°ãƒ©ãƒ•ä½œæˆ =====
function makePie(ctxId, dataObj, colorResolver, labelOrder=null, typeName=null, labelMapper=null) {
  let labels = Object.keys(dataObj || {});

  if (labelOrder) {
    labels = labelOrder.filter(k => k in dataObj);
  }

  const values = labels.map(k => dataObj[k]);
  const rawLabels = labels;
  const displayLabels = rawLabels.map(label =>
    labelMapper ? labelMapper(label) : label
  );

  const bgColors = rawLabels.map((label, idx) =>
    typeof colorResolver === "function" ? colorResolver(label, idx) : colorResolver[idx % colorResolver.length]
  );

  const ctx = document.getElementById(ctxId).getContext("2d");
  const chart = new Chart(ctx, {
    type: "pie",
    data: {
      labels: displayLabels,
      datasets: [{ data: values, backgroundColor: bgColors }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" },
        datalabels: {
          color: "#333",
          font: { weight: "bold", size: 12 },
          formatter: (val, ctx) => ctx.chart.data.labels[ctx.dataIndex]
        }
      },
      onClick: (e, elements) => {
        if (elements.length > 0) {
          const index = elements[0].index;
          const rawValue = rawLabels[index];
          const displayValue = displayLabels[index];
          showModal(typeName, rawValue, displayValue);
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}


// ===== ãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç† =====
function showModal(type, value, displayValue=null) {
  const params = new URLSearchParams({ type, value });
  fetch(`/stats_members?${params.toString()}`)
    .then(res => res.json())
    .then(members => {
      const modal = document.getElementById("memberModal");
      const titleLabel = displayValue || value;
      document.getElementById("modalTitle").textContent = `${titleLabel} ã®ãƒ¡ãƒ³ãƒãƒ¼`;

      const list = document.getElementById("memberList");
      list.innerHTML = "";

      if (members.length === 0) {
        list.innerHTML = "<li style='text-align:center;'>è©²å½“ãƒ¡ãƒ³ãƒãƒ¼ãªã—</li>";
      } else {
        members.forEach(m => {
          const li = document.createElement("li");
          li.textContent = m.name;
          list.appendChild(li);
        });
      }

      modal.style.display = "flex";
    });
}

function closeModal() {
  document.getElementById("memberModal").style.display = "none";
}


// ===== ã‚°ãƒ©ãƒ•æç”» =====
makePie(
  "mbtiChart",
  chartData.mbti,
  (label)=>MBTI_COLOR_MAP[label]||"#ccc",
  MBTI_ORDER,
  "mbti",
  (value)=>MBTI_LABELS_MAP[value] || value
);
makePie(
  "loveChart",
  chartData.love,
  COLORS.love,
  null,
  "love",
  (value)=>LOVE_LABELS_MAP[value] || value
);
makePie("bloodChart", chartData.blood, COLORS.blood, null, "blood");
makePie("tagChart", chartData.tags, COLORS.tags, null, "tag");
</script>

{% endblock %}
